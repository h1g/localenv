services_default:
  cli:
    image: '{{ cli_image }}'
    volumes:
      - '{{ source_dir }}:/var/www'
      - '{{ home_dir }}/.ssh/:{{ home_dir }}/.ssh/'
      - '{{ home_dir }}/.gitconfig:{{ home_dir }}/.gitconfig'
    command: '[ "bash" ]'

  fpm:
    image: "{{ cli_image + '_' + project + '_' + repo_name }}"
    volumes:
      - '{{ source_dir }}:/var/www'
      - '{{ home_dir }}/.ssh/:{{ home_dir }}/.ssh/'
      - '{{ home_dir }}/.gitconfig:{{ home_dir }}/.gitconfig'
    command: '["php-fpm", "--nodaemonize"]'

  workers:
    image: "{{ cli_image + '_' + project + '_' + repo_name }}"
    volumes:
      - '{{ source_dir }}:/var/www'
    command: '["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]'

  nginx:
    image: 'nginx:latest'
    volumes:
      - '{{ source_dir }}:/var/www'

  redis:
    image: 'redis:5.0.7-alpine'
    volumes:
      - /var/lib/redis

  rabbit:
    image: 'rabbitmq:latest'

  mailcatcher:
    image: 'sj26/mailcatcher:latest'
    command: '["mailcatcher", "--no-quit", "--foreground", "--ip=0.0.0.0", "--smtp-port=25", "--http-port=80"]'

  mongo:
    image: 'mongo:latest'
    command: '["mongod", "--logpath=/dev/null"]'
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin

  mysql:
    image: 'percona:8'
    command: '["mysqld", "--default-authentication-plugin=mysql_native_password"]'
    environment:
      - MYSQL_ROOT_PASSWORD=pass
      - MYSQL_DATABASE=db
      - MYSQL_USER=root
    volumes:
        - /var/lib/mysql

  postgres:
    image: 'postgres:12'
    environment:
      - POSTGRES_PASSWORD=unit
      - POSTGRES_USER=unit
      - POSTGRES_DB=unit
    volumes:
      - /var/lib/postgresql/data

  dns-nginx:
    image: 'nginx:latest'
    ports:
      - "80:80"
    volumes:
      - ./nginx.dns.conf:/etc/nginx/conf.d/default.conf

  ftp:
    image: 'bogem/ftp:latest'
    environment:
      - FTP_USER=ftp
      - FTP_PASS=ftp
      - PASV_ADDRESS=0.0.0.0
    volumes:
      - /home/vsftpd

  dind:
    image: 'docker:latest'
